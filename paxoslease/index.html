

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PaxosLease算法: 实现租约的无盘Paxos算法 &mdash; dsdoc v0.0.1</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="top" title="dsdoc v0.0.1" href="../index.html" />
    <link rel="prev" title="分布式系统文档" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../index.html" title="分布式系统文档"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">dsdoc v0.0.1</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="paxoslease-paxos">
<h1>PaxosLease算法: 实现租约的无盘Paxos算法<a class="headerlink" href="#paxoslease-paxos" title="永久链接至标题">¶</a></h1>
<p>原文名：PaxosLease: Diskless Paxos for Leases</p>
<p>Marton Trencseni, <a class="reference external" href="mailto:mtrencseni&#37;&#52;&#48;scalien&#46;com">mtrencseni<span>&#64;</span>scalien<span>&#46;</span>com</a>
Attila Gazso, <a class="reference external" href="mailto:agazso&#37;&#52;&#48;scalien&#46;com">agazso<span>&#64;</span>scalien<span>&#46;</span>com</a></p>
<p>这篇论文描述了PaxosLease算法，一种用于租约协商的分布式算法。PaxosLease基于Paxos算法，但无需写盘和时钟同步。PaxosLease在开源分布式复制KV存储Keyspace中被用来做Master租约协商。</p>
<div class="section" id="id1">
<h2>1. 介绍<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>在并发编程中，<em>锁</em> 是进程用来同步共享资源访问的基本原语。在锁以不设置过期时间方式分配（也没有一个监督进程）的系统中，锁的持有者在释放锁之前如果失效（Failure），就可能导致其它进程阻塞。</p>
<p>在高可用系统中，期望避免单点失效导致整个系统阻塞的情况。另外，“重启”失效的系统会比重启一个多线程程序要更困难。因此，在分布式系统中，<em>租约</em> 取代锁以避免饿死的情况。一个 <em>租约</em> 就是 <em>有过期时间的锁</em> 。如果锁的持有者失效了或是和其它结点断开连接，它的租约会自动过期，其它结点可以得到租约。</p>
<p>我们假设基本的步骤如下：系统由一组请求者和一组接受者组成，请求者和接受者都有各自的算法；系统没有拜占庭问题，即结点之间不会通过不遵守各自算法作弊（也没有被Hack）。接受者的数目是固定不变的。</p>
<p>一个朴素的多数派投票式的算法可以正确地解决分布式租约的问题；这里 <em>正确</em> 的意思是，任何时候租约不会被多于一个结点持有。但是，这个简单的算法在有多个请求者时会频繁 <em>阻塞</em> ，因此需要一个更成熟的方案。</p>
<p>朴素的多数派算法是这样的： 请求者启动一个开始本地超时计时，超时时间T秒，然后向接受者发送请求时长为T的租约。接受者收到请求后启动一个时长为T秒的定时器，然后发送接受消息给请求者。超时之后，接受者清除自己的状态。如果接受者收到一个请求但他的状态不是空，则接受者不回应或是发一个拒绝消息。为确保任何时间只有一个请求者能获得租约，请求者必须收到多数派的接受者的接受消息；这样它获取租约直到它本地的定时器超时。</p>
<p>正如上面讨论的，有多个请求者时，有可能（而且很有可能）没有请求者能得到多数派，请求者会一直互相阻塞着。举个例子，有3个请求者1、2、3和三个接受者A、B、C，如果分布状态是这样的：A接受1的请求，B接受2的和C接受3的，然后没有一个请求者得到多数派的接受。系统必须等到超时过期，接受者清空自己的状态，这时请求者会再重试。但很很可能会再次阻塞。</p>
<p>在本文描述的解决方法是采取Paxos <a class="footnote-reference" href="#id10" id="id2">[1]</a> 方案，引入 <em>准备</em> 和 <em>提案</em> 阶段，这样可以完全避免这类阻塞问题 <a class="footnote-reference" href="#id5" id="id3">[*]</a> 。Paxos解决复制状态机的问题，每个结点有一个本地的状态机拷贝，希望在下一个状态转换时结点间达成一致。Paxos是一个基于多数派的算法，意味着，多数派的结点没有宕并且之间可以通信，是可能的。Paxos达成一致的处理在一个状态转换上，所以在实践中，需要逐次运行多个Paxos实例来协商出一序列的状态转换 <a class="footnote-reference" href="#id12" id="id4">[3]</a> 。Paxos中，接受者在发送响应之前要先把自己的状态记录到盘上，以保证一旦一个值（状态转换）被选定，之后一直选定该值；换句话说，不管是否有出错情况出现，所有的状态机经历相同的状态转换序列。</p>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[*]</a></td><td>另一个解决方法是，让系统阻塞，但是引入一个“撤销”机制，让一个请求者撤销他们的请求从而让某个请求者可以获得租约。</td></tr>
</tbody>
</table>
<p>不像之前的那些基于Paxos的分布式租约算法，比如Fatlease <a class="footnote-reference" href="#id14" id="id6">[5]</a> ，PaxosLease不对结点的本地时钟做任务时间同步的假设（也不需要全局的同步）。另外，Fatlease为了租约命令连续地运行Paxos实例，而PaxosLease利用租约的临时性完全避免了这样的复杂性，是一个更简单和优雅的算法。</p>
<p>PaxosLease是Paxos的一个自然特化变种。因为在Paxos中假设结点个数是固定的（并且结点标识是全局已知的）。PaxosLease处理一个特殊的复制状态机，形式是：</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/PaxosLease-distributed-state-machine.png"><img alt="../_images/PaxosLease-distributed-state-machine.png" src="../_images/PaxosLease-distributed-state-machine.png" /></a>
<p class="caption">图1：PaxosLease的分布式状态机</p>
</div>
<p>为了获得租约，PaxosLease的请求者结点提交的值是“结点i持有租约”，在租约过期后将会自动返回“没有结点持有租约”。请求者也可以延长租约通过在前一次租约过期之前再次提交“结点i持有租约”值，或者在过期之前释放租约（可选操作）。</p>
<p>类似于Paxos，PaxosLease本质上处理了所有有关的失效情况：</p>
<ol class="arabic simple">
<li>结点停止和重启</li>
<li>网络分割断开</li>
<li>消息丢失和乱序</li>
<li>传输中的消息延时</li>
</ol>
</div>
<div class="section" id="id7">
<h2>2. 定义<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>一个PaxosLease单元由请求者和接受者组成。我们假设有 <em>n</em> 个接受者和任意个的请求者。在实践中，结点常常会同时扮演请求者和接受者的角色，但这是个实现上的问题不会影响这里的讨论。</p>
<p>请求者发送 <em>准备请求</em> （Prepare Request）和 <em>提案请求</em> （Propose Request）消息给接受者；接受者回复的是 <em>准备响应</em> （Prepare Response）和 <em>提案响应</em> （Propose Response）消息。这些消息有下面的结构：</p>
<ol class="arabic simple">
<li>准备请求 = 投票编号</li>
<li>提案请求 = 投票编号，响应结果，已经接受了的提案</li>
<li>准备响应 = 投票编号，租约</li>
<li>提案响应 = 投票编号，响应结果</li>
</ol>
<p>投票编号和租约两者组成 <em>提案</em> （Proposal）。 <em>租约</em> 由 <em>请求者id</em> （希望成为租约持有者的结点）和 时间间隔 <em>T</em> 组成。</p>
<p>接受者存储下面的状态信息：</p>
<ol class="arabic simple">
<li>承诺的最高编号： 接受者忽略投票编号小于该值的消息</li>
<li>已经接受的提案： 最后一个接受的提案（投票编号 和 租约）</li>
</ol>
<p>有一个全局已知的最大租约时间 <em>M</em> 。请求者请求的租约时间间隔 <em>T</em> 总是 &lt; <em>M</em> 。</p>
<p>每个请求者的投票编号是全局唯一的并且单调增加。在实践中，实现的方式可以是，投票编号由 <em>请求者id</em> 字段 ，一个 <em>重启计数器</em> 和 一个 请求次数的 <em>计数器</em> 字段 组成（可以处理最坏的情况）。每次请求者启动时重启计数器递增，并写到可靠的存储中。</p>
<p>PaxosLease保证了 <em>租约不变式</em> ：在任何给定的时间点，不会有多余1个请求者持有租约。</p>
</div>
<div class="section" id="id8">
<h2>3. 基本算法<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
</div>
<div class="section" id="id9">
<h2>参考<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><ol class="first last upperalpha simple" start="12">
<li>Lamport, The Part-Time Parliament, ACM Transactions on Computer Systems 16, 2 (May 1998), 133-169.</li>
</ol>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><ol class="first last upperalpha simple" start="12">
<li>Lamport, Paxos Made Simple, ACM SIGACT News 32, 4 (Dec. 2001), 18-25.</li>
</ol>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><ol class="first last upperalpha simple" start="20">
<li>Chandra, R. Griesemer, J. Redstone, Paxos Made Live - An Engineering Perspective, PODC ’07: 26th ACM Symposium on Principles of Distributed Computing</li>
</ol>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><ol class="first last upperalpha simple" start="13">
<li>Burrows, The Chubby Lock Service for Loosely-Coupled Distributed Systems, OSDI’06: Seventh Symposium on Operating System Design and Implementation.</li>
</ol>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td><ol class="first last upperalpha simple" start="6">
<li>Hupfeld et al., FaTLease: Scalable Fault-Tolerant Lease Negotiation with Paxos, HPDC08, June 2327, 2008, Boston, Massachusetts, USA.</li>
</ol>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td>AGPL License. <a class="reference external" href="http://www.fsf.org/licensing/licenses/agpl-3.0.html">http://www.fsf.org/licensing/licenses/agpl-3.0.html</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">PaxosLease算法: 实现租约的无盘Paxos算法</a><ul>
<li><a class="reference internal" href="#id1">1. 介绍</a></li>
<li><a class="reference internal" href="#id7">2. 定义</a></li>
<li><a class="reference internal" href="#id8">3. 基本算法</a></li>
<li><a class="reference internal" href="#id9">参考</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="../index.html"
                        title="上一章">分布式系统文档</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/paxoslease/index.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的模块，术语，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="../index.html" title="分布式系统文档"
             >上一页</a> |</li>
        <li><a href="../index.html">dsdoc v0.0.1</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; 版权所有 2012, Jerry Lee.
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>